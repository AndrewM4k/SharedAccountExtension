import{j as e,c as v,r as i,a as m,b as g,i as N}from"./apiService.js";const f=({actions:l,loading:n,totalCount:s,currentPage:o,pageSize:u,onPageChange:d})=>{const a=Math.ceil(s/u),h=r=>{try{return JSON.parse(r)}catch{return{}}};return n?e.jsx("div",{className:"loading-indicator",children:"Загрузка событий..."}):e.jsxs("div",{className:"actions-table",children:[e.jsxs("table",{className:"table m-3",children:[e.jsx("thead",{className:"thead-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Пользовательский ID"}),e.jsx("th",{children:"Имя"}),e.jsx("th",{children:"Время"}),e.jsx("th",{children:"Событие"}),e.jsx("th",{children:"Номер лота"}),e.jsx("th",{children:"Детали"}),e.jsx("th",{children:"Details"})]})}),e.jsx("tbody",{children:l&&l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"no-data",children:"Нет событий"})}):l&&l.map(r=>{const x=r.commentary?h(r.commentary):{},j=r.details||"";return e.jsxs("tr",{children:[e.jsx("td",{children:r.userId}),e.jsx("td",{children:r.username||"N/A"}),e.jsx("td",{children:new Date(r.actionTime).toLocaleString()}),e.jsx("td",{children:e.jsx("span",{className:`action-badge ${r.actionType.toLowerCase()}`,children:r.actionType})}),e.jsx("td",{children:r.lotNumber||"N/A"}),e.jsx("td",{className:"details-cell",children:e.jsx("div",{className:"details-summary",children:Object.entries(x).map(([c,t])=>e.jsxs("div",{children:[e.jsxs("strong",{children:[c,":"]})," ",String(t)]},c))})}),e.jsx("td",{children:j||"N/A"})]},r.id)})})]}),a>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{disabled:o===1,onClick:()=>d(o-1),children:"Предыдущая"}),e.jsxs("span",{children:["Страница ",o," of ",a]}),e.jsx("button",{disabled:o===a,onClick:()=>d(o+1),children:"Следующая"})]})]})},b=[{value:"",label:"All Actions"},{value:"BID",label:"Bids"},{value:"VIEW",label:"View"},{value:"LOGIN",label:"Logins"}],w=({filters:l,onFilterChange:n})=>e.jsxs("div",{className:"action-filters w50",children:[e.jsx("div",{className:"filter-row w100",children:e.jsxs("div",{className:"filter-group w90",children:[e.jsx("label",{children:"Поиск (по имени и действию):"}),e.jsx("input",{className:"form-control",type:"text",placeholder:"Поиск по имени пользователя или типу действия...",value:l.search,onChange:s=>n({search:s.target.value})})]})}),e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"ID пользователя:"}),e.jsx("input",{className:"form-control",type:"text",placeholder:"ID пользователя",value:l.userId,onChange:s=>n({userId:s.target.value})})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Тип события:"}),e.jsx("select",{className:"form-select",value:l.actionType,onChange:s=>n({actionType:s.target.value}),children:b.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsx("div",{className:"filter-row",children:e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Фильтр по номеру лота:"}),e.jsx("input",{className:"form-control",type:"text",placeholder:"Поиск по номеру лота...",value:l.lotNumber,onChange:s=>n({lotNumber:s.target.value})})]})}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Штук на странице:"}),e.jsxs("select",{className:"form-select",value:l.pageSize,onChange:s=>n({pageSize:Number(s.target.value)}),children:[e.jsx("option",{value:"10",children:"10"}),e.jsx("option",{value:"20",children:"20"}),e.jsx("option",{value:"50",children:"50"}),e.jsx("option",{value:"100",children:"100"})]})]})]}),e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Дата начала:"}),e.jsx("input",{className:"form-control",type:"date",value:l.startDate,onChange:s=>n({startDate:s.target.value})})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Дата окончания:"}),e.jsx("input",{className:"form-control",type:"date",value:l.endDate,onChange:s=>n({endDate:s.target.value})})]})]})]}),D=()=>{const[l,n]=i.useState([]),[s,o]=i.useState(!0),[u,d]=i.useState(0),[a,h]=i.useState({page:1,pageSize:20,actionType:"",search:"",userId:"",startDate:"",endDate:"",lotNumber:""}),r=async()=>{o(!0);const c=await m();if(console.log("accessTokenResponse: ",c),c.status!==200){const t=await g();if(console.log("refreshResponse: ",t),t.status!==200)throw new Error("Refresh failed");const p=await m();if(console.log("accessTokenResponse: ",p),p.status!==200)throw new Error("Still not authenticated after refresh")}try{const t=await N({page:a.page,pageSize:a.pageSize,actionType:a.actionType||void 0,search:a.search||void 0,userId:a.userId||void 0,startDate:a.startDate||void 0,endDate:a.endDate||void 0,lotNumber:a.lotNumber||void 0});if(t.status!==200)throw new Error("Failed to fetch actions");console.log("response.data ",t.data),n(t.data.data||[]),d(t.data.totalCount||0)}catch(t){console.error("Error fetching actions:",t)}finally{o(!1)}};i.useEffect(()=>{r()},[a]);const x=c=>{h(t=>({...t,page:c}))},j=c=>{h(t=>({...t,...c,page:1}))};return e.jsxs("div",{className:"dashboard-container",children:[e.jsx("h1",{children:"Пользовательские действия"}),e.jsx(w,{filters:a,onFilterChange:j}),e.jsx(f,{actions:l,loading:s,totalCount:u,currentPage:a.page,pageSize:a.pageSize,onPageChange:x})]})},y=v.createRoot(document.getElementById("root"));y.render(e.jsx(D,{}));
