import{j as e,c as E,r,R as y,a as N,m as v,b as L,l as I,d as M,e as O}from"./apiService.js";const U=({variant:a="danger",children:n})=>e.jsx("div",{className:`alert ${a}`,children:n}),P=()=>{const[a,n]=r.useState(""),[g,R]=r.useState(""),[c,l]=r.useState(!1),[f,i]=r.useState(!1),[h,x]=r.useState(null),[b,u]=r.useState(null),[m,d]=r.useState("");y.useEffect(()=>{h!=null&&!h&&(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"}))},[h]);const j=async()=>{try{if((await N()).status===200){const s=await v();return x(!0),i(!0),d(s.data.role),n(s.data.username),s.data.role}}catch{console.log("Check failed");try{if((await L()).status===200){const o=await N();if(console.log("статус собновления токенов: ",o.status),o.status===200){const w=await v();i(!0),d(w.data.role),n(w.data.username);return}}}catch(s){console.log("Refresh token failed:",s)}}i(!1),d(""),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"})};y.useEffect(()=>{l(!0),f||j(),l(!1)},[]);const S=async t=>{t.preventDefault(),l(!0),u("");try{if((await M(a,g)).status===200){x(!1);try{p("Выполняется авторизация...");const o=await chrome.runtime.sendMessage({action:"authAndSetCookies"});o&&o.success?(p("Авторизация успешна!"),setTimeout(()=>{chrome.tabs.create({url:"https://www.copart.com"}),window.close()},1e3)):p("Ошибка: "+(o?.error||"Неизвестная ошибка"))}catch(o){console.error("Ошибка:",o),p("Ошибка: "+o.message)}j()}}catch(s){console.error("Full login error:",s),O.isAxiosError(s)?s.response?.status===401?u("Неверное имя пользователя или пароль"):u(`Ошибка сервера: ${s.response?.status} - ${s.response?.statusText}`):u("Неизвестная ошибка при входе")}finally{l(!1)}};function p(t){console.log("message: ",t)}const k=async()=>{try{await I(),console.log("logOut"),chrome.runtime.sendMessage({action:"clearCookies"}),i(!1),d("")}catch(t){console.error("Logout error:",t)}},C=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})},A=()=>{chrome.tabs.create({url:chrome.runtime.getURL("dashboard.html")})};return c?e.jsx("div",{className:"popup-container ",children:e.jsx("div",{className:"popup-text fs1_7",children:"Проверка авторизации..."})}):e.jsx("div",{className:"popup-container",children:f?e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Добро пожаловать в Shared Account"}),e.jsxs("div",{className:"popup-text border2",children:["Логин:"," ",e.jsx("strong",{children:a}),e.jsx("br",{}),"Позиция:"," ",e.jsx("strong",{children:m=="0"?"Администратор":"Пользователь"})]}),m=="0"&&e.jsx("button",{onClick:C,className:"btn btn-primary",children:"Панель администратора"}),m=="0"&&e.jsx("button",{onClick:A,className:"btn btn-primary",children:"Пользовательские действия"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:k,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:S,children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:a,onChange:t=>n(t.target.value),disabled:c})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:g,onChange:t=>R(t.target.value),disabled:c})}),b&&e.jsx(U,{children:b}),e.jsx("button",{type:"submit",disabled:c,className:"btn btn-primary",children:c?"Вход...":"Войти"})]})})},T=E.createRoot(document.getElementById("root"));T.render(e.jsx(P,{}));
