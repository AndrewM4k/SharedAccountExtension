import{j as e,c as A,r,R as y}from"./client.js";import{c as v,m as N,r as L,a as R,l as I}from"./apiService.js";const M=({variant:a="danger",children:n})=>e.jsx("div",{className:`alert ${a}`,children:n}),O=()=>{const[a,n]=r.useState(""),[m,S]=r.useState(""),[c,l]=r.useState(!1),[g,i]=r.useState(!1),[h,f]=r.useState(null),[x,u]=r.useState(null),[j,d]=r.useState("");y.useEffect(()=>{h!=null&&!h&&(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"}))},[h]);const b=async()=>{try{if((await v()).status===200){const s=await N();return f(!0),i(!0),d(s.data.role),n(s.data.username),s.data.role}}catch{console.log("Check failed");try{if((await L()).status===200){const o=await v();if(console.log("статус собновления токенов: ",o.status),o.status===200){const w=await N();i(!0),d(w.data.role),n(w.data.username);return}}}catch(s){console.log("Refresh token failed:",s)}}i(!1),d(""),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"})};y.useEffect(()=>{l(!0),g||b(),l(!1)},[]);const k=async t=>{t.preventDefault(),l(!0),u("");try{if((await I(a,m)).status===200){f(!1);try{p("Выполняется авторизация...");const o=await chrome.runtime.sendMessage({action:"authAndSetCookies"});o&&o.success?(p("Авторизация успешна!"),setTimeout(()=>{chrome.tabs.create({url:"https://www.copart.com"}),window.close()},1e3)):p("Ошибка: "+(o?.error||"Неизвестная ошибка"))}catch(o){console.error("Ошибка:",o),p("Ошибка: "+o.message)}b()}}catch(s){console.error("Full login error:",s),R.isAxiosError(s)?s.response?.status===401?u("Неверное имя пользователя или пароль"):u(`Ошибка сервера: ${s.response?.status} - ${s.response?.statusText}`):u("Неизвестная ошибка при входе")}finally{l(!1)}};function p(t){console.log("message: ",t)}const C=async()=>{try{await R.post("https://localhost:5001/api/auth/logout",{},{withCredentials:!0}),console.log("logOut"),chrome.runtime.sendMessage({action:"clearCookies"}),i(!1),d("")}catch(t){console.error("Logout error:",t)}},E=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})};return c?e.jsx("div",{className:"popup-container",children:e.jsx("div",{className:"popup-text",children:"Проверка авторизации..."})}):e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),g?e.jsxs("div",{className:"popup-container",children:[e.jsxs("div",{className:"popup-text",children:["Вы вошли как: ",e.jsx("strong",{children:a}),e.jsx("br",{}),"Роль:"," ",e.jsx("strong",{children:j=="0"?"Администратор":"Пользователь"})]}),j=="0"&&e.jsx("button",{onClick:E,className:"btn btn-primary",children:"Панель администратора"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:C,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:k,children:[e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:a,onChange:t=>n(t.target.value),disabled:c})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:m,onChange:t=>S(t.target.value),disabled:c})}),x&&e.jsx(M,{children:x}),e.jsx("button",{type:"submit",disabled:c,className:"btn btn-primary",children:c?"Вход...":"Войти"})]})]})},P=A.createRoot(document.getElementById("root"));P.render(e.jsx(O,{}));
