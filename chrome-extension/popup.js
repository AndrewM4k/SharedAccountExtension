import{j as e,c as I,r as a,R as N,a as R,m as v,b as M,l as O,d as U,e as P}from"./apiService.js";const T=({variant:r="danger",children:n})=>e.jsx("div",{className:`alert ${r}`,children:n}),$=()=>{const[r,n]=a.useState(""),[m,k]=a.useState(""),[c,o]=a.useState(!1),[g,l]=a.useState(!1),[p,f]=a.useState(null),[x,i]=a.useState(null),[h,u]=a.useState("");N.useEffect(()=>{p!=null&&!p&&(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"}))},[p]);const b=async()=>{try{if((await R()).status===200){const t=await v();return f(!0),l(!0),u(t.data.role),n(t.data.username),t.data.role}}catch{console.log("Check failed");try{if((await M()).status===200){const w=await R();if(console.log("статус собновления токенов: ",w.status),w.status===200){const y=await v();l(!0),u(y.data.role),n(y.data.username);return}}}catch(t){console.log("Refresh token failed:",t)}}l(!1),u(""),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"})};N.useEffect(()=>{o(!0),g||b(),o(!1)},[]);const C=async s=>{s.preventDefault(),o(!0),i("");try{(await U(r,m)).status===200&&(f(!1),await j(),b())}catch(t){console.error("Full login error:",t),P.isAxiosError(t)?t.response?.status===401?i("Неверное имя пользователя или пароль"):i(`Ошибка сервера: ${t.response?.status} - ${t.response?.statusText}`):i("Неизвестная ошибка при входе")}finally{o(!1)}};async function j(){try{d("Выполняется авторизация...");const s=await chrome.runtime.sendMessage({action:"authAndSetCookies"});s&&s.success?(d("Авторизация успешна!"),setTimeout(()=>{chrome.tabs.create({url:"https://www.copart.com"}),window.close()},1e3)):d("Ошибка: "+(s?.error||"Неизвестная ошибка"))}catch(s){console.error("Ошибка:",s),d("Ошибка: "+s.message)}}function d(s){console.log("message: ",s)}const S=async()=>{try{await O(),console.log("logOut"),chrome.runtime.sendMessage({action:"clearCookies"}),l(!1),u("")}catch(s){console.error("Logout error:",s)}},A=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})},E=()=>{chrome.tabs.create({url:chrome.runtime.getURL("dashboard.html")})};if(c)return e.jsx("div",{className:"popup-container ",children:e.jsx("div",{className:"popup-text fs1_7",children:"Проверка авторизации..."})});async function L(){o(!0),chrome.runtime.sendMessage({action:"clearCookies"}),await j(),o(!1)}return e.jsx("div",{className:"popup-container",children:g?e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Добро пожаловать в Shared Account"}),e.jsxs("div",{className:"popup-text border2",children:["Логин:"," ",e.jsx("strong",{children:r}),e.jsx("br",{}),"Позиция:"," ",e.jsx("strong",{children:h=="0"?"Администратор":"Пользователь"})]}),h=="0"&&e.jsx("button",{onClick:A,className:"btn btn-primary",children:"Панель администратора"}),h=="0"&&e.jsx("button",{onClick:E,className:"btn btn-primary",children:"Пользовательские действия"}),e.jsx("button",{onClick:L,className:"btn btn-primary",children:"Повторная авторизация на Copart"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:S,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:C,children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:r,onChange:s=>n(s.target.value),disabled:c})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:m,onChange:s=>k(s.target.value),disabled:c})}),x&&e.jsx(T,{children:x}),e.jsx("button",{type:"submit",disabled:c,className:"btn btn-primary",children:c?"Вход...":"Войти"})]})})},z=I.createRoot(document.getElementById("root"));z.render(e.jsx($,{}));
