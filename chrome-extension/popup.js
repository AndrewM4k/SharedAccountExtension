import{j as e,c as E,r as a,R as v}from"./client.js";import{c as y,m as N,r as L,a as R,l as A}from"./apiService.js";const I=({variant:o="danger",children:r})=>e.jsx("div",{className:`alert ${o}`,children:r}),O=()=>{const[o,r]=a.useState(""),[p,w]=a.useState(""),[n,c]=a.useState(!1),[h,l]=a.useState(!1),[d,m]=a.useState(null),[g,i]=a.useState(null),[f,u]=a.useState("");v.useEffect(()=>{d!=null&&!d&&(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"}))},[d]);const x=async()=>{try{if((await y()).status===200){const s=await N();return m(!0),l(!0),u(s.data.role),r(s.data.username),s.data.role}}catch{console.log("Check failed");try{if((await L()).status===200){const j=await y();if(console.log("стату собновленяи токенов: ",j.status),j.status===200){const b=await N();l(!0),u(b.data.role),r(b.data.username);return}}}catch(s){console.log("Refresh token failed:",s)}}l(!1),u(""),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"})};v.useEffect(()=>{c(!0),h||x(),c(!1)},[]);const S=async t=>{t.preventDefault(),c(!0),i("");try{(await A(o,p)).status===200&&(m(!1),x())}catch(s){console.error("Full login error:",s),R.isAxiosError(s)?s.response?.status===401?i("Неверное имя пользователя или пароль"):i(`Ошибка сервера: ${s.response?.status} - ${s.response?.statusText}`):i("Неизвестная ошибка при входе")}finally{c(!1)}},k=async()=>{try{await R.post("https://localhost:5001/api/auth/logout",{},{withCredentials:!0}),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"}),l(!1),u("")}catch(t){console.error("Logout error:",t)}},C=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})};return n?e.jsx("div",{className:"popup-container",children:e.jsx("div",{className:"popup-text",children:"Проверка авторизации..."})}):e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),h?e.jsxs("div",{className:"popup-container",children:[e.jsxs("div",{className:"popup-text",children:["Вы вошли как: ",e.jsx("strong",{children:o}),e.jsx("br",{}),"Роль:"," ",e.jsx("strong",{children:f=="0"?"Администратор":"Пользователь"})]}),f=="0"&&e.jsx("button",{onClick:C,className:"btn btn-primary",children:"Панель администратора"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:k,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:S,children:[e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:o,onChange:t=>r(t.target.value),disabled:n})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:p,onChange:t=>w(t.target.value),disabled:n})}),g&&e.jsx(I,{children:g}),e.jsx("button",{type:"submit",disabled:n,className:"btn btn-primary",children:n?"Вход...":"Войти"})]})]})},M=E.createRoot(document.getElementById("root"));M.render(e.jsx(O,{}));
