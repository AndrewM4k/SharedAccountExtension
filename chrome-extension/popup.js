import{j as e,c as k,r as a,R as j}from"./client.js";import{c as b,m as v,r as E,a as y,l as C}from"./apiService.js";const L=({variant:r="danger",children:o})=>e.jsx("div",{className:`alert ${r}`,children:o}),A=()=>{const[r,o]=a.useState(""),[p,N]=a.useState(""),[n,c]=a.useState(!1),[d,l]=a.useState(!1),[h,i]=a.useState(null),[m,u]=a.useState("");j.useEffect(()=>{d?(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"})):(console.log("Stop auth"),chrome.runtime.sendMessage({action:"logoutOnCopart"}))},[d]);const g=async()=>{try{if((await b()).status===200){const s=await v();return l(!0),u(s.data.role),o(s.data.username),s.data.role}}catch{console.log("Check failed");try{if((await E()).status===200){const f=await b();if(console.log("стату собновленяи токенов: ",f.status),f.status===200){const x=await v();l(!0),u(x.data.role),o(x.data.username);return}}}catch(s){console.log("Refresh token failed:",s)}}l(!1),u("")};j.useEffect(()=>{c(!0),g(),c(!1)},[]);const R=async t=>{t.preventDefault(),c(!0),i("");try{(await C(r,p)).status===200&&g()}catch(s){console.error("Full login error:",s),y.isAxiosError(s)?s.response?.status===401?i("Неверное имя пользователя или пароль"):i(`Ошибка сервера: ${s.response?.status} - ${s.response?.statusText}`):i("Неизвестная ошибка при входе")}finally{c(!1)}},w=async()=>{try{await y.post("https://localhost:5001/api/auth/logout",{},{withCredentials:!0}),l(!1),u("")}catch(t){console.error("Logout error:",t)}},S=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})};return n?e.jsx("div",{className:"popup-container",children:e.jsx("div",{className:"popup-text",children:"Проверка авторизации..."})}):e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),d?e.jsxs("div",{className:"popup-container",children:[e.jsxs("div",{className:"popup-text",children:["Вы вошли как: ",e.jsx("strong",{children:r}),e.jsx("br",{}),"Роль:"," ",e.jsx("strong",{children:m=="0"?"Администратор":"Пользователь"})]}),m=="0"&&e.jsx("button",{onClick:S,className:"btn btn-primary",children:"Панель администратора"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:w,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:R,children:[e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:r,onChange:t=>o(t.target.value),disabled:n})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:p,onChange:t=>N(t.target.value),disabled:n})}),h&&e.jsx(L,{children:h}),e.jsx("button",{type:"submit",disabled:n,className:"btn btn-primary",children:n?"Вход...":"Войти"})]})]})},I=k.createRoot(document.getElementById("root"));I.render(e.jsx(A,{}));
