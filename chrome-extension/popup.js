import{j as e,c as L,r,R as N}from"./client.js";import{c as R,m as S,r as I,l as M,a as O,b as P}from"./apiService.js";const T=({variant:n="danger",children:c})=>e.jsx("div",{className:`alert ${n}`,children:c}),U=()=>{const[n,c]=r.useState(""),[x,k]=r.useState(""),[l,d]=r.useState(!1),[b,p]=r.useState(!1),[f,j]=r.useState(null),[w,m]=r.useState(null),[v,h]=r.useState("");N.useEffect(()=>{f!=null&&!f&&(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"}))},[f]);const y=async()=>{try{if((await R()).status===200){const t=await S();return j(!0),p(!0),h(t.data.role),c(t.data.username),t.data.role}}catch{console.log("Check failed");try{if((await I()).status===200){const i=await R();if(console.log("статус собновления токенов: ",i.status),i.status===200){const u=await S();p(!0),h(u.data.role),c(u.data.username);return}}}catch(t){console.log("Refresh token failed:",t)}}p(!1),h(""),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"})};N.useEffect(()=>{d(!0),b||y(),d(!1)},[]);const A=async s=>{var t,i,u;s.preventDefault(),d(!0),m("");try{if((await O(n,x)).status===200){j(!1);try{g("Выполняется авторизация...");const o=await chrome.runtime.sendMessage({action:"authAndSetCookies"});o&&o.success?(g("Авторизация успешна!"),setTimeout(()=>{chrome.tabs.create({url:"https://www.copart.com"}),window.close()},1e3)):g("Ошибка: "+((o==null?void 0:o.error)||"Неизвестная ошибка"))}catch(o){console.error("Ошибка:",o),g("Ошибка: "+o.message)}y()}}catch(a){console.error("Full login error:",a),P.isAxiosError(a)?((t=a.response)==null?void 0:t.status)===401?m("Неверное имя пользователя или пароль"):m(`Ошибка сервера: ${(i=a.response)==null?void 0:i.status} - ${(u=a.response)==null?void 0:u.statusText}`):m("Неизвестная ошибка при входе")}finally{d(!1)}};function g(s){console.log("message: ",s)}const C=async()=>{try{await M(),console.log("logOut"),chrome.runtime.sendMessage({action:"clearCookies"}),p(!1),h("")}catch(s){console.error("Logout error:",s)}},E=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})};return l?e.jsx("div",{className:"popup-container ",children:e.jsx("div",{className:"popup-text fs1_7",children:"Проверка авторизации..."})}):e.jsx("div",{className:"popup-container",children:b?e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Добро пожаловать в Shared Account"}),e.jsxs("div",{className:"popup-text border2",children:["Логин:"," ",e.jsx("strong",{children:n}),e.jsx("br",{}),"Позиция:"," ",e.jsx("strong",{children:v=="0"?"Администратор":"Пользователь"})]}),v=="0"&&e.jsx("button",{onClick:E,className:"btn btn-primary",children:"Панель администратора"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:C,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:A,children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:n,onChange:s=>c(s.target.value),disabled:l})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:x,onChange:s=>k(s.target.value),disabled:l})}),w&&e.jsx(T,{children:w}),e.jsx("button",{type:"submit",disabled:l,className:"btn btn-primary",children:l?"Вход...":"Войти"})]})})},$=L.createRoot(document.getElementById("root"));$.render(e.jsx(U,{}));
