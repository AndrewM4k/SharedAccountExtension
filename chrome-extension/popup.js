import{j as e,c as C,r,R as v}from"./client.js";import{c as y,m as N,r as E,l as L,a as I,b as M}from"./apiService.js";const O=({variant:a="danger",children:n})=>e.jsx("div",{className:`alert ${a}`,children:n}),P=()=>{const[a,n]=r.useState(""),[h,R]=r.useState(""),[c,l]=r.useState(!1),[g,i]=r.useState(!1),[m,f]=r.useState(null),[x,u]=r.useState(null),[b,d]=r.useState("");v.useEffect(()=>{m!=null&&!m&&(console.log("Start auth"),chrome.runtime.sendMessage({action:"authOnCopart"}))},[m]);const j=async()=>{try{if((await y()).status===200){const s=await N();return f(!0),i(!0),d(s.data.role),n(s.data.username),s.data.role}}catch{console.log("Check failed");try{if((await E()).status===200){const o=await y();if(console.log("статус собновления токенов: ",o.status),o.status===200){const w=await N();i(!0),d(w.data.role),n(w.data.username);return}}}catch(s){console.log("Refresh token failed:",s)}}i(!1),d(""),console.log("logOut"),chrome.runtime.sendMessage({action:"logoutOnCopart"})};v.useEffect(()=>{l(!0),g||j(),l(!1)},[]);const S=async t=>{t.preventDefault(),l(!0),u("");try{if((await I(a,h)).status===200){f(!1);try{p("Выполняется авторизация...");const o=await chrome.runtime.sendMessage({action:"authAndSetCookies"});o&&o.success?(p("Авторизация успешна!"),setTimeout(()=>{chrome.tabs.create({url:"https://www.copart.com"}),window.close()},1e3)):p("Ошибка: "+(o?.error||"Неизвестная ошибка"))}catch(o){console.error("Ошибка:",o),p("Ошибка: "+o.message)}j()}}catch(s){console.error("Full login error:",s),M.isAxiosError(s)?s.response?.status===401?u("Неверное имя пользователя или пароль"):u(`Ошибка сервера: ${s.response?.status} - ${s.response?.statusText}`):u("Неизвестная ошибка при входе")}finally{l(!1)}};function p(t){console.log("message: ",t)}const k=async()=>{try{await L(),console.log("logOut"),chrome.runtime.sendMessage({action:"clearCookies"}),i(!1),d("")}catch(t){console.error("Logout error:",t)}},A=()=>{chrome.tabs.create({url:chrome.runtime.getURL("admin.html")})};return c?e.jsx("div",{className:"popup-container ",children:e.jsx("div",{className:"popup-text fs1_7",children:"Проверка авторизации..."})}):e.jsx("div",{className:"popup-container",children:g?e.jsxs("div",{className:"popup-container",children:[e.jsx("div",{className:"popup-header",children:" Добро пожаловать в Shared Account"}),e.jsxs("div",{className:"popup-text border2",children:["Логин:"," ",e.jsx("strong",{children:a}),e.jsx("br",{}),"Позиция:"," ",e.jsx("strong",{children:b=="0"?"Администратор":"Пользователь"})]}),b=="0"&&e.jsx("button",{onClick:A,className:"btn btn-primary",children:"Панель администратора"}),e.jsx("div",{className:"logged-btn",children:e.jsx("button",{onClick:k,className:"btn btn-outline-secondary",children:"Выйти"})})]}):e.jsxs("form",{onSubmit:S,children:[e.jsx("div",{className:"popup-header",children:" Вход в Shared Account"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"username","aria-label":"Имя пользователя",type:"text",value:a,onChange:t=>n(t.target.value),disabled:c})}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{className:"form-control input",id:"password",type:"password","aria-label":"Пароль",value:h,onChange:t=>R(t.target.value),disabled:c})}),x&&e.jsx(O,{children:x}),e.jsx("button",{type:"submit",disabled:c,className:"btn btn-primary",children:c?"Вход...":"Войти"})]})})},T=C.createRoot(document.getElementById("root"));T.render(e.jsx(P,{}));
